name: Assemble NWSL Documentary
on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (use placeholders)'
        required: false
        default: true
        type: boolean

jobs:
  run:
    permissions:
      id-token: write
      contents: read
    runs-on: ubuntu-latest

    steps:
      - name: Checkout HUSTLE repo
        uses: actions/checkout@v4

      - name: Environment Setup and Gate Check
        run: |
          echo "PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}" >> .env
          echo "REGION=us-central1" >> .env
          echo "GCS_BUCKET=gs://${{ secrets.GCP_PROJECT_ID }}-media" >> .env
          echo "DRY_RUN=${{ inputs.dry_run }}" >> .env

          # Source environment
          set -a
          source .env
          set +a

          # Export for subsequent steps
          echo "PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          echo "REGION=us-central1" >> $GITHUB_ENV
          echo "GCS_BUCKET=gs://${{ secrets.GCP_PROJECT_ID }}-media" >> $GITHUB_ENV
          echo "DRY_RUN=${{ inputs.dry_run }}" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Verify CI Gate
        run: |
          cd nwsl
          bash -eux gate.sh

      - name: Set path variables
        run: |
          echo "SRC_ROOT=$(pwd)" >> $GITHUB_ENV
          echo "NWSL_ROOT=$(pwd)/nwsl" >> $GITHUB_ENV
          echo "DOCS_ROOT=$(pwd)/docs" >> $GITHUB_ENV
          echo "ASSETS_ROOT=$(pwd)/001-assets" >> $GITHUB_ENV

      - name: Import specs from NWSL repo
        run: |
          echo "ðŸ“š Importing specifications from NWSL repo..."

          # Create necessary directories
          mkdir -p docs/imported
          mkdir -p 001-assets/refs/imagen
          mkdir -p 040-overlays

          # Import critical documents
          rsync -av --include='*/' \
            --include='6767-PP-PROD-master-brief.md' \
            --include='*-DR-REFF-veo-seg-*.md' \
            --include='*-DR-REFF-lyria-*.md' \
            --include='*-OD-CONF-generation-switches.md' \
            --include='*-overlay-*.md' \
            --include='*-overlay-*.csv' \
            --exclude='*' \
            "$NWSL_ROOT/docs/" "docs/imported/" || true

          # Import overlay files
          rsync -av "$NWSL_ROOT/040-overlays/" "040-overlays/" || true

          # Import any existing assets
          rsync -av --include='*/' --include='*.png' --include='*.jpg' --exclude='*' \
            "$NWSL_ROOT/001-assets/" "001-assets/" || true

          echo "âœ… Import complete"
          ls -la docs/imported/

      - name: Install ffmpeg
        if: ${{ inputs.dry_run }}
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Generate placeholder media (if dry run)
        if: ${{ inputs.dry_run }}
        run: |
          echo "ðŸŽ¬ Generating placeholder media for dry run..."

          # Create directories
          mkdir -p 020-audio/music
          mkdir -p 030-video/shots

          # Generate placeholder video segments
          for i in {1..8}; do
              N=$(printf "%02d" $i)
              echo "Creating placeholder SEG-${N}..."

              # SEG-08 is shorter (4.01s), others are 8.0s
              if [ "$i" -eq 8 ]; then
                  DUR="4.01"
              else
                  DUR="8.0"
              fi

              ffmpeg -f lavfi -i "color=c=black:s=1920x1080:d=$DUR" \
                  -r 24 \
                  -vf "drawtext=text='SEG-${N} PLACEHOLDER':fontsize=72:fontcolor=white:x=(w-text_w)/2:y=(h-text_h)/2" \
                  "030-video/shots/SEG-${N}_best.mp4" -y
          done

          # Generate silent audio (60.04 seconds)
          echo "Creating placeholder audio..."
          ffmpeg -f lavfi -i "anullsrc=channel_layout=stereo:sample_rate=48000" \
              -t 60.04 \
              "020-audio/music/master_mix.wav" -y

          echo "âœ… Placeholder media created"
          ls -la 030-video/shots/
          ls -la 020-audio/music/

      - name: Lyria render (instrumental only)
        if: ${{ !inputs.dry_run }}
        run: |
          echo "ðŸŽµ Rendering Lyria score..."
          bash -eux 050-scripts/lyria_render.sh || echo "âš ï¸ Lyria render script not found - skipping"

      - name: Veo renders
        if: ${{ !inputs.dry_run }}
        run: |
          echo "ðŸŽ¬ Rendering Veo segments..."
          bash -eux 050-scripts/veo_render.sh || echo "âš ï¸ Veo render script not found - skipping"

      - name: Assembly preflight check
        run: |
          echo "ðŸ” Running preflight checks..."

          # Check for required files
          READY=true

          for i in {01..08}; do
              FILE="030-video/shots/SEG-${i}_best.mp4"
              if [ ! -f "$FILE" ]; then
                  echo "âŒ Missing: $FILE"
                  READY=false
              else
                  echo "âœ… Found: $FILE"
              fi
          done

          if [ ! -f "020-audio/music/master_mix.wav" ]; then
              echo "âŒ Missing: 020-audio/music/master_mix.wav"
              READY=false
          else
              echo "âœ… Found: 020-audio/music/master_mix.wav"
          fi

          if [ "$READY" = false ]; then
              echo "âŒ Preflight check failed - missing required files"
              exit 1
          fi

          echo "âœ… All required files present"

      - name: Assemble master
        run: |
          echo "ðŸŽ¬ Assembling master video..."

          # Use the overlay pipeline from NWSL repo if it exists
          if [ -f "nwsl/050-scripts/ffmpeg_overlay_pipeline.sh" ]; then
              echo "Using NWSL overlay pipeline..."
              bash -eux "nwsl/050-scripts/ffmpeg_overlay_pipeline.sh" \
                  "030-video/assembly/video_with_music.mp4" \
                  "060-renders/final/master_16x9.mp4" || true
          else
              echo "Using fallback assembly..."
              bash -eux 050-scripts/ffmpeg_overlay_pipeline.sh --master 16x9 || \
                  echo "âš ï¸ Assembly script not found - skipping"
          fi

      - name: Quality control
        run: |
          echo "ðŸ“Š Running quality control checks..."

          # Check if output exists
          if [ -f "060-renders/final/master_16x9.mp4" ]; then
              # Video properties
              ffprobe -v error -select_streams v:0 \
                  -show_entries stream=width,height,r_frame_rate \
                  -of default=noprint_wrappers=1 \
                  "060-renders/final/master_16x9.mp4"

              # Duration
              ffprobe -v error -show_entries format=duration \
                  -of default=noprint_wrappers=1:nokey=1 \
                  "060-renders/final/master_16x9.mp4"

              echo "âœ… Master video created successfully"
          else
              echo "âš ï¸ Master video not found"
          fi

      - name: Upload artifacts to GCS
        if: always()
        run: |
          echo "â˜ï¸ Uploading artifacts to GCS..."

          # Create run-specific path
          RUN_PATH="ci/${{ github.run_id }}_${{ github.run_attempt }}"

          # Upload renders if they exist
          if [ -d "060-renders" ]; then
              gcloud storage cp -r 060-renders "gs://${{ secrets.GCP_PROJECT_ID }}-media/$RUN_PATH/" || true
          fi

          # Upload shots if they exist
          if [ -d "030-video/shots" ]; then
              gcloud storage cp -r 030-video/shots "gs://${{ secrets.GCP_PROJECT_ID }}-media/$RUN_PATH/" || true
          fi

          # Upload audio if it exists
          if [ -d "020-audio/music" ]; then
              gcloud storage cp -r 020-audio/music "gs://${{ secrets.GCP_PROJECT_ID }}-media/$RUN_PATH/" || true
          fi

          echo "âœ… Upload complete"
          echo "Artifacts available at: gs://${{ secrets.GCP_PROJECT_ID }}-media/$RUN_PATH/"

      - name: Write CI documentation
        if: always()
        run: |
          echo "ðŸ“ Writing CI documentation..."

          # Calculate next document number
          NEXT=$(printf "%03d" $(($(ls docs 2>/dev/null | sed -n 's/^\([0-9][0-9][0-9]\)-.*/\1/p' | sort -n | tail -1)+1)))

          # Write CI runbook
          cat > "docs/${NEXT}-OD-DEPL-ci-runbook.md" << EOF
          # CI Runbook - GitHub Actions Execution
          **Date:** $(date +%Y-%m-%d)
          **Run ID:** ${{ github.run_id }}
          **Run Number:** ${{ github.run_number }}

          ## Configuration
          - **Run Mode:** GitHub Actions with WIF
          - **Dry Run:** ${{ inputs.dry_run }}
          - **Project ID:** ${{ secrets.GCP_PROJECT_ID }}
          - **NWSL Repo SHA:** $(git -C nwsl rev-parse --short HEAD 2>/dev/null || echo "unknown")
          - **HUSTLE Repo SHA:** ${{ github.sha }}

          ## Artifacts
          - **GCS Location:** gs://${{ secrets.GCP_PROJECT_ID }}-media/ci/${{ github.run_id }}_${{ github.run_attempt }}/
          - **Master Video:** 060-renders/final/master_16x9.mp4

          ## Status
          - Workflow completed at: $(date +%Y-%m-%d\ %H:%M:%S)
          EOF

          echo "âœ… Documentation written to docs/${NEXT}-OD-DEPL-ci-runbook.md"

      - name: Upload workflow artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nwsl-documentary-${{ github.run_id }}
          path: |
            060-renders/
            docs/*-OD-DEPL-*.md
            vertex_ops.log