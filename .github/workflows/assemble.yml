name: Assemble NWSL Documentary
on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (use placeholders)'
        required: false
        default: true
        type: boolean

concurrency:
  group: assemble-production
  cancel-in-progress: true

jobs:
  run:
    timeout-minutes: 120
    permissions:
      id-token: write
      contents: read
    runs-on: ubuntu-latest

    steps:
      - name: Checkout HUSTLE repo
        uses: actions/checkout@v4

      - name: Environment Setup and Gate Check
        run: |
          echo "PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}" >> .env
          echo "REGION=us-central1" >> .env
          echo "GCS_BUCKET=gs://${{ secrets.GCP_PROJECT_ID }}-media" >> .env
          echo "DRY_RUN=${{ inputs.dry_run }}" >> .env

          # Source environment
          set -a
          source .env
          set +a

          # Export for subsequent steps
          echo "PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          echo "REGION=us-central1" >> $GITHUB_ENV
          echo "GCS_BUCKET=gs://${{ secrets.GCP_PROJECT_ID }}-media" >> $GITHUB_ENV
          echo "DRY_RUN=${{ inputs.dry_run }}" >> $GITHUB_ENV
          echo "DOCS_DIR=./docs" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Verify CI Gate
        run: |
          cd nwsl
          bash -eux gate.sh

      - name: Set path variables
        run: |
          echo "SRC_ROOT=$(pwd)" >> $GITHUB_ENV
          echo "NWSL_ROOT=$(pwd)/nwsl" >> $GITHUB_ENV
          echo "DOCS_ROOT=$(pwd)/docs" >> $GITHUB_ENV
          echo "ASSETS_ROOT=$(pwd)/001-assets" >> $GITHUB_ENV

      - name: Import specs from NWSL repo
        run: |
          echo "üìö Importing specifications from NWSL repo..."

          # Create necessary directories
          mkdir -p docs/imported
          mkdir -p 001-assets/refs/imagen
          mkdir -p 040-overlays

          # Import critical documents
          rsync -av --include='*/' \
            --include='6767-PP-PROD-master-brief.md' \
            --include='*-DR-REFF-veo-seg-*.md' \
            --include='*-DR-REFF-lyria-*.md' \
            --include='*-OD-CONF-generation-switches.md' \
            --include='*-overlay-*.md' \
            --include='*-overlay-*.csv' \
            --exclude='*' \
            "$NWSL_ROOT/docs/" "docs/imported/" || true

          # Import overlay files
          rsync -av "$NWSL_ROOT/040-overlays/" "040-overlays/" || true

          # Import any existing assets
          rsync -av --include='*/' --include='*.png' --include='*.jpg' --exclude='*' \
            "$NWSL_ROOT/001-assets/" "001-assets/" || true

          echo "‚úÖ Import complete"
          ls -la docs/imported/

      - name: Verify canon files
        run: |
          echo "üîç Verifying canon files for Veo segments..."

          # Create docs symlink to nwsl/000-docs
          cd nwsl
          if [ -d "000-docs" ]; then
            ln -sf 000-docs docs
            echo "‚úÖ Created symlink: docs ‚Üí 000-docs"
          fi

          # Check for required canon files
          CANON_OK=true
          for i in 01 02 03 04 05 06 07 08; do
            FILE_NUM=$((10#$i + 3))
            CANON_FILE=$(printf "docs/%03d-DR-REFF-veo-seg-%s.md" $FILE_NUM $i)

            if [ -f "$CANON_FILE" ]; then
              echo "‚úÖ Found: $CANON_FILE"
              # Show first few lines for verification
              head -3 "$CANON_FILE"
            else
              echo "‚ùå Missing: $CANON_FILE"
              CANON_OK=false
            fi
          done

          # Also check overlay canon
          if [ -f "000-docs/6767-DR-REFF-overlays-16x9.md" ]; then
            echo "‚úÖ Found overlay canon: 000-docs/6767-DR-REFF-overlays-16x9.md"
          else
            echo "‚ùå Missing overlay canon"
            CANON_OK=false
          fi

          if [ "$CANON_OK" = false ]; then
            echo "‚ùå Canon files missing - cannot proceed"
            echo "Listing all docs:"
            ls -la 000-docs/ || echo "000-docs not found"
            ls -la docs/ || echo "docs not found"
            exit 1
          fi

          echo "‚úÖ All canon files verified"

      - name: Install ffmpeg
        if: always()
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq

      - name: Generate placeholder media (if dry run)
        if: ${{ inputs.dry_run }}
        run: |
          echo "üé¨ Generating placeholder media for dry run..."

          # Create directories
          mkdir -p 020-audio/music
          mkdir -p 030-video/shots

          # Generate placeholder video segments
          for i in {1..8}; do
              N=$(printf "%02d" $i)
              echo "Creating placeholder SEG-${N}..."

              # SEG-08 is shorter (4.01s), others are 8.0s
              if [ "$i" -eq 8 ]; then
                  DUR="4.01"
              else
                  DUR="8.0"
              fi

              ffmpeg -f lavfi -i "color=c=black:s=1920x1080:d=$DUR" \
                  -r 24 \
                  -vf "drawtext=text='SEG-${N} PLACEHOLDER':fontsize=72:fontcolor=white:x=(w-text_w)/2:y=(h-text_h)/2" \
                  "030-video/shots/SEG-${N}_best.mp4" -y
          done

          # Generate silent audio (60.04 seconds)
          echo "Creating placeholder audio..."
          ffmpeg -f lavfi -i "anullsrc=channel_layout=stereo:sample_rate=48000" \
              -t 60.04 \
              "020-audio/music/master_mix.wav" -y

          echo "‚úÖ Placeholder media created"
          ls -la 030-video/shots/
          ls -la 020-audio/music/

      - name: Lyria render (instrumental only)
        if: ${{ !inputs.dry_run }}
        timeout-minutes: 20
        working-directory: nwsl
        run: bash -eux 050-scripts/lyria_render.sh

      - name: Veo renders
        if: ${{ !inputs.dry_run }}
        timeout-minutes: 60
        working-directory: nwsl
        run: bash -eux 050-scripts/veo_render.sh

      - name: Assembly preflight check
        run: |
          echo "üîç Running preflight checks..."

          # Check for required files
          READY=true

          for i in {01..08}; do
              FILE="nwsl/030-video/shots/SEG-${i}_best.mp4"
              if [ ! -f "$FILE" ]; then
                  echo "‚ùå Missing: $FILE"
                  READY=false
              else
                  echo "‚úÖ Found: $FILE"
              fi
          done

          if [ ! -f "nwsl/020-audio/music/master_mix.wav" ]; then
              echo "‚ùå Missing: nwsl/020-audio/music/master_mix.wav"
              READY=false
          else
              echo "‚úÖ Found: nwsl/020-audio/music/master_mix.wav"
          fi

          if [ "$READY" = false ]; then
              echo "‚ùå Preflight check failed - missing required files"
              exit 1
          fi

          echo "‚úÖ All required files present"

      - name: Process overlays
        run: |
          echo "üé® Processing overlay files..."
          cd nwsl

          # Sync overlay canon to working directory
          if [ -f "050-scripts/overlay_sync.sh" ]; then
              bash -eux 050-scripts/overlay_sync.sh
          fi

          # Build ASS file from overlay canon
          if [ -f "050-scripts/overlay_build.sh" ]; then
              bash -eux 050-scripts/overlay_build.sh
          fi

      - name: Assemble master
        run: |
          echo "üé¨ Assembling master video with 9 segments..."
          cd nwsl

          # Use the new 9-segment assembly script
          if [ -f "050-scripts/ffmpeg_assembly_9seg.sh" ]; then
              echo "Using 9-segment assembly pipeline..."
              bash -eux "050-scripts/ffmpeg_assembly_9seg.sh"
          else
              echo "‚ùå Assembly script not found: 050-scripts/ffmpeg_assembly_9seg.sh"
              exit 1
          fi

      - name: Quality control
        run: |
          echo "üìä Running quality control checks..."

          # Check if output exists
          OUTPUT_FILE="nwsl/060-renders/final/master_16x9.mp4"
          if [ -f "$OUTPUT_FILE" ]; then
              echo "‚úÖ Master video found at: $OUTPUT_FILE"

              # Video properties
              echo "Video properties:"
              ffprobe -v error -select_streams v:0 \
                  -show_entries stream=width,height,r_frame_rate \
                  -of default=noprint_wrappers=1 \
                  "$OUTPUT_FILE"

              # Duration
              DURATION=$(ffprobe -v error -show_entries format=duration \
                  -of default=noprint_wrappers=1:nokey=1 \
                  "$OUTPUT_FILE")
              echo "Duration: ${DURATION}s"

              # File size
              SIZE=$(du -h "$OUTPUT_FILE" | cut -f1)
              echo "File size: $SIZE"

              # Check acceptance criteria
              SIZE_BYTES=$(stat -c%s "$OUTPUT_FILE" 2>/dev/null || stat -f%z "$OUTPUT_FILE")
              if [ "$SIZE_BYTES" -gt 52428800 ]; then
                  echo "‚úÖ File size > 50MB - good quality"
              else
                  echo "‚ö†Ô∏è File size < 50MB - may have quality issues"
              fi

              echo "‚úÖ Master video created successfully"
          else
              echo "‚ùå Master video not found at: $OUTPUT_FILE"
              exit 1
          fi

      - name: Query Vertex AI logs
        if: always()
        working-directory: nwsl
        timeout-minutes: 5
        run: |
          echo "üîç Querying Vertex AI logs for observability..."

          # Make script executable
          chmod +x 050-scripts/query_vertex_logs.sh

          # Run query with CI export
          CI=true GITHUB_RUN_ID="${{ github.run_id }}" \
            PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}" \
            HOURS_BACK=1 \
            ./050-scripts/query_vertex_logs.sh || {
              echo "‚ö†Ô∏è Log query failed - continuing anyway"
            }

          # List any error documentation created
          if ls docs/*-LS-STAT-*.md 2>/dev/null; then
              echo "üìù Error documentation found:"
              ls -la docs/*-LS-STAT-*.md
          fi

      - name: Upload artifacts to GCS
        if: always()
        run: |
          echo "‚òÅÔ∏è Uploading artifacts to GCS..."

          # Create run-specific path
          RUN_PATH="ci/${{ github.run_id }}_${{ github.run_attempt }}"

          # Upload renders if they exist
          if [ -d "nwsl/060-renders" ]; then
              gcloud storage cp -r nwsl/060-renders "gs://${{ secrets.GCP_PROJECT_ID }}-media/$RUN_PATH/" || true
          fi

          # Upload shots if they exist
          if [ -d "nwsl/030-video/shots" ]; then
              gcloud storage cp -r nwsl/030-video/shots "gs://${{ secrets.GCP_PROJECT_ID }}-media/$RUN_PATH/" || true
          fi

          # Upload audio if it exists
          if [ -d "nwsl/020-audio/music" ]; then
              gcloud storage cp -r nwsl/020-audio/music "gs://${{ secrets.GCP_PROJECT_ID }}-media/$RUN_PATH/" || true
          fi

          # Upload vertex operations log if it exists
          if [ -f "nwsl/vertex_ops.log" ]; then
              gcloud storage cp nwsl/vertex_ops.log "gs://${{ secrets.GCP_PROJECT_ID }}-media/$RUN_PATH/" || true
          fi

          echo "‚úÖ Upload complete"
          echo "Artifacts available at: gs://${{ secrets.GCP_PROJECT_ID }}-media/$RUN_PATH/"

      - name: Write CI documentation
        if: always()
        run: |
          echo "üìù Writing CI documentation..."

          # Calculate next document number (force base-10 to avoid octal interpretation)
          LAST_NUM=$(ls nwsl/000-docs 2>/dev/null | sed -n 's/^\([0-9][0-9][0-9]\)-.*/\1/p' | sort -n | tail -1)
          NEXT=$(printf "%03d" $((10#${LAST_NUM:-0} + 1)))

          # Write CI runbook
          cat > "nwsl/000-docs/${NEXT}-OD-DEPL-ci-runbook.md" << EOF
          # CI Runbook - GitHub Actions Execution
          **Date:** $(date +%Y-%m-%d)
          **Run ID:** ${{ github.run_id }}
          **Run Number:** ${{ github.run_number }}

          ## Configuration
          - **Run Mode:** GitHub Actions with WIF
          - **Dry Run:** ${{ inputs.dry_run }}
          - **Project ID:** ${{ secrets.GCP_PROJECT_ID }}
          - **NWSL Repo SHA:** $(git -C nwsl rev-parse --short HEAD 2>/dev/null || echo "unknown")
          - **HUSTLE Repo SHA:** ${{ github.sha }}

          ## Artifacts
          - **GCS Location:** gs://${{ secrets.GCP_PROJECT_ID }}-media/ci/${{ github.run_id }}_${{ github.run_attempt }}/
          - **Master Video:** 060-renders/final/master_16x9.mp4

          ## Status
          - Workflow completed at: $(date +%Y-%m-%d\ %H:%M:%S)
          EOF

          echo "‚úÖ Documentation written to nwsl/000-docs/${NEXT}-OD-DEPL-ci-runbook.md"

      - name: Upload workflow artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nwsl-documentary-${{ github.run_id }}
          path: |
            nwsl/060-renders/
            nwsl/030-video/shots/
            nwsl/020-audio/music/
            nwsl/000-docs/*-OD-DEPL-*.md
            nwsl/vertex_ops.log