rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function emailVerified() {
      return request.auth.token.email_verified == true;
    }

    // Users collection
    match /users/{userId} {
      // Users can read and write their own document
      allow read: if isOwner(userId);

      // Users can create their own document during registration
      allow create: if isAuthenticated() && isOwner(userId);

      // Users can update their own document (require email verification)
      allow update: if isOwner(userId) && emailVerified();

      // Users can delete their own document (COPPA compliance)
      allow delete: if isOwner(userId);

      // Players subcollection (child profiles)
      match /players/{playerId} {
        // Parent can read all their players
        allow read: if isOwner(userId);

        // Parent can create players (must be verified)
        allow create: if isOwner(userId) && emailVerified();

        // Parent can update their players
        allow update: if isOwner(userId) && emailVerified();

        // Parent can delete their players
        allow delete: if isOwner(userId);

        // Games subcollection (stats for each player)
        match /games/{gameId} {
          // Parent can read all games for their players
          allow read: if isOwner(userId);

          // Parent can create games (must be verified)
          allow create: if isOwner(userId) && emailVerified();

          // Parent can update games
          allow update: if isOwner(userId) && emailVerified();

          // Parent can delete games
          allow delete: if isOwner(userId);
        }
      }
    }

    // Waitlist collection (public write for early access signups)
    match /waitlist/{email} {
      // Anyone can create a waitlist entry
      allow create: if true;

      // No one can read, update, or delete (admin only via console)
      allow read, update, delete: if false;
    }

    // Email logs collection (system only - for Cloud Functions)
    match /emailLogs/{logId} {
      // No direct client access (admin/functions only)
      allow read, write: if false;
    }

    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
